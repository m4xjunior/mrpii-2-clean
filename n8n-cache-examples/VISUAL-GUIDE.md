# ๐ Guia Visual - Cache no N8N

## ๐ฏ Fluxo ANTES (Sem Cache) - LENTO โ

```
โโโโโโโโโโโโโโโโโโโ
โ  Client Request โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  N8N Webhook    โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  SQL Query      โ  โ 150ms (SEMPRE executa!)
โ  (15 mรกquinas)  โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  Process Data   โ  โ 20ms
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  Return JSON    โ
โโโโโโโโโโโโโโโโโโโ

TOTAL: ~170ms por request
```

---

## ๐ Fluxo DEPOIS (Com Cache) - RรPIDO โ

### Request 1 (Cache Miss):

```
โโโโโโโโโโโโโโโโโโโ
โ  Client Request โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  N8N Webhook    โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  Check Cache    โ  โ 1ms
โ  โ MISS        โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  SQL Query      โ  โ 150ms
โ  (15 mรกquinas)  โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  ๐พ Save Cache  โ  โ 2ms (salva na memรณria)
โ  TTL: 30s       โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  Return JSON    โ
โโโโโโโโโโโโโโโโโโโ

TOTAL: ~153ms (primeira vez)
```

### Request 2, 3, 4... (Cache Hit):

```
โโโโโโโโโโโโโโโโโโโ
โ  Client Request โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  N8N Webhook    โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  Check Cache    โ  โ 1ms
โ  โ HIT (20s)   โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  Return Cache   โ  โ 1ms (direto da memรณria!)
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  Return JSON    โ
โโโโโโโโโโโโโโโโโโโ

TOTAL: ~2ms (30x MAIS RรPIDO! ๐)
```

---

## ๐ Timeline de Cache (30 segundos):

```
Tempo (s)    Request    Resultado      Tempo
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
0            Req #1     Cache MISS     153ms  โ Query SQL
1            Req #2     Cache HIT      2ms    โ Da memรณria!
2            Req #3     Cache HIT      2ms    โ Da memรณria!
5            Req #4     Cache HIT      2ms    โ Da memรณria!
10           Req #5     Cache HIT      2ms    โ Da memรณria!
15           Req #6     Cache HIT      2ms    โ Da memรณria!
20           Req #7     Cache HIT      2ms    โ Da memรณria!
25           Req #8     Cache HIT      2ms    โ Da memรณria!
30           Req #9     Cache MISS     153ms  โ Expirou! Query SQL novamente
31           Req #10    Cache HIT      2ms    โ Novo cache salvo
```

---

## ๐ฆ Estrutura dos Nodes no N8N:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    N8N WORKFLOW                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                          โ
โ  โโโโโโโโโโโโโโโ                                         โ
โ  โ  Webhook    โ  POST /webhook/maquinas                 โ
โ  โโโโโโโโฌโโโโโโโ                                         โ
โ         โ                                                โ
โ         โผ                                                โ
โ  โโโโโโโโโโโโโโโ                                         โ
โ  โ Check Cache โ  JavaScript: verificar cache           โ
โ  โโโโโโโโฌโโโโโโโ                                         โ
โ         โ                                                โ
โ         โผ                                                โ
โ  โโโโโโโโโโโโโโโ                                         โ
โ  โ  IF Node    โ  fromCache == true?                    โ
โ  โโโโฌโโโโโโโโโฌโโ                                         โ
โ     โ        โ                                           โ
โ  TRUEโ        โFALSE                                     โ
โ     โ        โ                                           โ
โ     โผ        โผ                                           โ
โ  โโโโโโโโ  โโโโโโโโโโโโ                                 โ
โ  โReturnโ  โSQL Query โ  SELECT * FROM Maquinas         โ
โ  โCache โ  โโโโโโฌโโโโโโ                                 โ
โ  โโโโฌโโโโ       โ                                        โ
โ     โ           โผ                                        โ
โ     โ      โโโโโโโโโโโโ                                 โ
โ     โ      โSave Cacheโ  Salvar por 30s                 โ
โ     โ      โโโโโโฌโโโโโโ                                 โ
โ     โ           โ                                        โ
โ     โโโโโโโโโโโโโ                                        โ
โ          โ                                               โ
โ          โผ                                               โ
โ   โโโโโโโโโโโโโโโ                                        โ
โ   โ   Response  โ  Return JSON                          โ
โ   โโโโโโโโโโโโโโโ                                        โ
โ                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐จ Cรณdigo Visual do Cache:

### Check Cache (Node 1):

```javascript
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ Verificar se cache existe        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ const cache = $workflow.staticData; โ
โ                                     โ
โ if (cache.maquinas) {               โ
โ   const age = calcular_idade();    โ
โ                                     โ
โ   if (age < 30s) {                  โ
โ     return CACHE;  โ โ HIT         โ
โ   }                                 โ
โ }                                   โ
โ                                     โ
โ return FETCH_NEW;  โ โ MISS        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Save Cache (Node 2):

```javascript
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐พ Salvar dados no cache            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ const data = $input.all();          โ
โ                                     โ
โ $workflow.staticData.maquinas = {   โ
โ   timestamp: AGORA,                 โ
โ   data: data                        โ
โ };                                  โ
โ                                     โ
โ console.log('Cache salvo!');        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Mรฉtricas de Performance:

### Sem Cache:
```
Requests/min: 60
Tempo mรฉdio: 150ms
Carga DB: 100% (60 queries/min)
```

### Com Cache (30s):
```
Requests/min: 60
Tempo mรฉdio: 7ms  โ 95% mais rรกpido!
Carga DB: 3.3%    โ 2 queries/min (a cada 30s)
```

**Economia de recursos: 96.7%** ๐

---

## ๐ง Ajustar TTL:

```javascript
// Cache muito agressivo (dados podem estar desatualizados)
const CACHE_TTL_SECONDS = 300; // 5 minutos

// Cache balanceado โญ RECOMENDADO
const CACHE_TTL_SECONDS = 30;  // 30 segundos

// Cache mรญnimo (pouco benefรญcio)
const CACHE_TTL_SECONDS = 5;   // 5 segundos
```

---

## โ Checklist de Implementaรงรฃo:

- [ ] Abrir workflow "Machines API" no N8N
- [ ] Adicionar node "Code" (Check Cache) ANTES da query
- [ ] Adicionar node "IF" para verificar cache hit
- [ ] Adicionar node "Code" (Return Cache) se TRUE
- [ ] Adicionar node "Code" (Save Cache) DEPOIS da query
- [ ] Conectar os nodes conforme diagrama
- [ ] Testar: primeira request deve ser lenta, prรณximas rรกpidas
- [ ] Verificar logs: "โ Cache hit" ou "โ Cache miss"
- [ ] Ajustar TTL se necessรกrio

**Tempo total: 5 minutos** โฑ๏ธ
